integrations:
  - name: nri-flex
    interval: 300s
    env:
      ## Uncomment these variables and set to remove all infrastructure agent metadata appended to data within NRDB
      # INSIGHTS_API_KEY: <ingest_key>
      # INSIGHTS_URL: https://insights-collector.newrelic.com/v1/accounts/<account_id>/events
      EVENT_LIMIT: 100000
    config:
      name: gcp-bq-flex
      variable_store:
        service_account_email: service-account@project123.iam.gserviceaccount.com # Requred
        project_id: my-project-id-123456 # Required
        region: us # Required
      apis:
        ## Initial authentication of service account - only required 1 time via running flex manually, otherwise comment out
        # - name: bq-auth
        #   event_type: bq_auth
        #   ignore_output: true
        #   commands:
        #     - run: gcloud auth activate-service-account ${var:service_account_email} --key-file=/home/ubuntu/tmp/my-service-account.json
        - name: bq-column
          event_type: bq_table_column_count
          commands:
            - run: bq query --project_id=${var:project_id} --use_legacy_sql=false --quiet=true --format=json "SELECT table_name, COUNT(column_name) as column_count FROM \`${var:project_id}.region-${var:region}.INFORMATION_SCHEMA.COLUMNS\` GROUP BY table_Name"
              timeout: 90000
        - name: bq-table-storage
          event_type: bq_table_stats
          commands:
            - run: bq query --project_id=${var:project_id} --use_legacy_sql=false --quiet=true --format=json "SELECT table_name, total_rows, total_partitions, total_logical_bytes, total_physical_bytes FROM \`${var:project_id}\`.\`region-${var:region}\`.INFORMATION_SCHEMA.TABLE_STORAGE"
              timeout: 90000
        - name: bq-jobs
          event_type: bq_table_ingest_rate
          commands:
            - run: bq query --project_id=${var:project_id} --use_legacy_sql=false --quiet=true --format=json "SELECT error_result.message AS error_message, COUNT(*) AS failure_count FROM `region-us`.INFORMATION_SCHEMA.JOBS_BY_USER WHERE error_result.message IS NOT NULL GROUP BY error_message ORDER BY failure_count DESC"
              timeout: 90000